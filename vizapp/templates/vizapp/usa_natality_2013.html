{% extends 'vizapp/base.html' %}
{% block content %}
<div class='vis_left_side'>
	{% for item in vis %}
		<div class='vis_left_title'>{{item.vis_name}}</div>
		<div class='vis_left_cat_container'>
			<div class='vis_left_cat_title'>Category:</div>
			<div class='vis_left_cat'>{{item.category}}</div>
			<div class='clear'></div>
		</div>
		<div class='vis_left_description_title'>Description:</div>
		<div class='vis_left_description'>{{item.description}}</div>

		<div class='index_date_container'>
			<div class='index_latest_descrip_title'>Date Published:</div>
			<div class='index_date_pub'>{{item.pub_date}}</div>
			<div class='index_latest_descrip_title'>Last Edited:</div>
			<div class='index_date_edit'>{{item.last_edit}}</div>
		</div>
	{% endfor %}
</div>
<div class='vis_right_side'>
	<div id='visualization'></div>
</div>
<div class='clear'></div>

<script>
$(document).ready( function(){
	/* NAV SHIT */
	$("#nav_home").click( function() { window.location.href = "/"; });
	$("#nav_datasets").click( function() { window.location.href = "/datasets/"; });
	$("#nav_about").click( function() { window.location.href = "/about/"; });

	/* D3 SHIT */
	var width  = 960,
	    height = 500,
	    active = d3.select(null);
	
	var projection = d3.geo.albersUsa()
			 .scale(1000)
			 .translate( [width / 2, height / 2] );
	
	var path = d3.geo.path()
		   .projection( projection );

	var color = d3.scale.ordinal()
		    .domain( d3.range(9).reverse() )
		    .range( [ "#ffffd9",
			      "#edf8b1",
			      "#c7e9b4",
			      "#7fcdbb",
			      "#41b6c4",
			      "#1d91c0",
			      "#225ea8",
			      "#253494",
			      "#081d58" ] );


	var svg = d3.select( "#visualization" )
		  .append( "svg" )
		  .attr( "width", width )
		  .attr( "height", height );

	svg.append( "rect" )
		.attr( "class", "d3_background" )
		.attr( "width", width )
		.attr( "height", height )
		.on( "click", reset );

	var g = svg.append( "g" )
		.style( "stroke-width", "1.5px" );

	d3.json( "/static/vizapp/us-states.json", function( error, us ){
		if( error ) throw error;
	
	d3.json( "/static/vizapp/natality_2013.json", function( nat ) {
		/*
		g.selectAll( "path" )
			.data( topojson.feature( us, us.objects.states ).features )
			.enter()
			.append( "path" )
			.attr( "d", path )
			.attr( "class", "d3_feature" )
			.on( "click", clicked );
		console.log( nat.total );
			.data( topojson.feature( us, us.objects.states ).features )
		*/
		g.selectAll( "path" )
			.data( us.features )
			.enter()
			.append( "path" )
			.attr( "d", path )
			.style( "fill", function(d) {
				var return_val = "FFF";
				console.log( us );
				//console.log( us.features.properties.name );
				for( var i = 0; i < nat.numbers.length; ++i )
				{
					/*
					if( us === nat.numbers[i].state )
						return_val = color( nat.numbers[i].births );
					*/
				}
				return return_val;
						
			})
			.on( "click", clicked );
		g.append( "path" )
			/*.datum( topojson.mesh( us, us.objects.states, function(a,b){ return a !== b; } ) )*/
			
			.attr( "class", "d3_mesh" )
			.attr( "d", path );
	});
	});

	function clicked(d){
		if( active.node() === this ) return reset();
		active.classed( "active", false );
		active = d3.select(this).classed("active", true);

		var bounds = path.bounds(d),
			dx = bounds[1][0] - bounds[0][0],
			dy = bounds[1][1] - bounds[0][1],
			x  = (bounds[0][0] + bounds[1][0] ) / 2,
			y  = (bounds[0][1] + bounds[1][1] ) / 2,
			scale = .9 / Math.max( dx / width, dy / height ),
			translate = [ width / 2 - scale * x, height / 2 - scale * y ];

		g.transition()
			.duration(750)
			.style( "stroke-width", 1.5 / scale + "px" )
			.attr( "transform", "translate(" + translate + ")scale(" + scale + ")" );
	}
	function reset()
	{
		active.classed("active", false);
		active = d3.select(null);

		g.transition()
			.duration(750)
			.style( "stroke-width", "1.5px" )
			.attr( "transform", "" );
	}
});
</script>

{% endblock content %}
